!function(t,n){"object"==typeof exports&&"undefined"!=typeof module?n(exports):"function"==typeof define&&define.amd?define(["exports"],n):n(t.relation={})}(this,function(t){"use strict";function n(t,n){if(t!==n)throw new Error("Mismatched types: "+t+" !== "+n);return t}function e(t,e){return n(t[0].typecheck(e),t[1].typecheck(e)),R}function r(t,n){for(var e=[];t>0;--t)e.push(n);switch(void 0===n?"undefined":M(n)){case"string":return new ht(T,e);case"number":return new ht(S,e);case"boolean":return new ht(R,e);default:return new ht(x,e)}}function i(t,n,e){var r=t.length;if(r!==n.length)throw new Error("length doesn't match");for(var i=[],o=0;o<r;o++){var u=t[o],c=n[o];null==u||null==c?i.push(null):i.push(e(u,c))}return i}function o(t,n){return t.map(n)}function u(t,n){return t.map(function(t){return null==t?null:n(t)})}function c(t,n,e){var r=_t(t.children[0],n);if(r.type!==S)throw new Error("Runtime Error: wrong type");var o=_t(t.children[1],n);if(o.type!==S)throw new Error("Runtime Error: wrong type");var u=i(r.data,o.data,e);return new lt(u)}function f(t,n){return c(t,n,function(t,n){return t+n})}function a(t,n){return c(t,n,function(t,n){return t-n})}function h(t,n){return c(t,n,function(t,n){return t*n})}function s(t,n){return c(t,n,function(t,n){return t/n})}function l(t,n){var e=n.find(function(n){var e=L(n,2),r=e[0];e[1];return t.name===r});if(null==e)throw new Error("Missing reference "+t.name);return e[1]}function p(t,n){return r(n[0][1].data.length,t.value)}function y(t,n,e){var r=_t(t.children[0],n),o=_t(t.children[1],n);if(r.type!==o.type)throw new Error("Runtime Error: wrong type");var u=i(r.data,o.data,e);return new yt(u)}function _(t,n,e){var r=_t(t.children[0],n),o=_t(t.children[1],n);if(r.type!==R)throw new Error("Runtime Error: wrong type");if(o.type!==R)throw new Error("Runtime Error: wrong type");var u=i(r.data,o.data,e);return new yt(u)}function v(t,n){return y(t,n,function(t,n){return t===n})}function d(t,n){return y(t,n,function(t,n){return t!==n})}function w(t,n){return y(t,n,function(t,n){return t>n})}function b(t,n){return y(t,n,function(t,n){return t>=n})}function O(t,n){return y(t,n,function(t,n){return t<n})}function g(t,n){return y(t,n,function(t,n){return t<=n})}function m(t,n){return _(t,n,function(t,n){return t&&n})}function k(t,n){var e=o(_t(t.children[0],n).data,function(t){return null==t});return new yt(e)}function j(t,n){var e=_t(t.children[0],n);if(e.type!==R)throw new Error("Runtime Error: wrong type");var r=u(e.data,function(t){return!t});return new yt(r)}function P(t,n,e){if("count"===t)return(n||0)+1;if("cvl"===t)return null==e?n||0:(n||0)+1;if(null==e)return n;if(null==n)return e;switch(t){case"min":return e<n?e:n;case"max":return e>n?e:n;case"sum":return(n||0)+(e||0);default:throw new Error("Unexpected op: "+t)}}function E(t){var n={},e=!0,r=!1,i=void 0;try{for(var o,u=t[Symbol.iterator]();!(e=(o=u.next()).done);e=!0){var c=o.value,f=L(c,2),a=f[0],h=f[1];if(null!=n[a])throw new Error("Duplicate field name: "+a);n[a]=h.type}}catch(t){r=!0,i=t}finally{try{!e&&u.return&&u.return()}finally{if(r)throw i}}return n}var x="unknown",S="number",T="string",R="boolean",M="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},N=function(t,n){if(!(t instanceof n))throw new TypeError("Cannot call a class as a function")},A=function(){function t(t,n){for(var e=0;e<n.length;e++){var r=n[e];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(n,e,r){return e&&t(n.prototype,e),r&&t(n,r),n}}(),I=function(t,n){if("function"!=typeof n&&null!==n)throw new TypeError("Super expression must either be null or a function, not "+typeof n);t.prototype=Object.create(n&&n.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),n&&(Object.setPrototypeOf?Object.setPrototypeOf(t,n):t.__proto__=n)},C=function(t,n){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!n||"object"!=typeof n&&"function"!=typeof n?t:n},L=function(){function t(t,n){var e=[],r=!0,i=!1,o=void 0;try{for(var u,c=t[Symbol.iterator]();!(r=(u=c.next()).done)&&(e.push(u.value),!n||e.length!==n);r=!0);}catch(t){i=!0,o=t}finally{try{!r&&c.return&&c.return()}finally{if(i)throw o}}return e}return function(n,e){if(Array.isArray(n))return n;if(Symbol.iterator in Object(n))return t(n,e);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),U=function(){function t(n,e){N(this,t),this.children=n,this.op=e}return A(t,[{key:"typecheck",value:function(t){throw new Error("typecheck() is not implemented")}}]),t}(),Y=function(t){function n(t,e){N(this,n);var r=C(this,(n.__proto__||Object.getPrototypeOf(n)).call(this,[t],e));return r.input=t,r}return I(n,U),n}(),G=function(t){function n(t){return N(this,n),C(this,(n.__proto__||Object.getPrototypeOf(n)).call(this,[],t))}return I(n,U),n}(),q=function(t){function n(t,e){return N(this,n),C(this,(n.__proto__||Object.getPrototypeOf(n)).call(this,[t],e))}return I(n,U),n}(),z=function(t){function n(t,e,r){return N(this,n),C(this,(n.__proto__||Object.getPrototypeOf(n)).call(this,[t,e],r))}return I(n,U),n}(),B=function(t){function n(t){N(this,n);var e=C(this,(n.__proto__||Object.getPrototypeOf(n)).call(this,"reference"));return e.name=t,e}return I(n,G),A(n,[{key:"typecheck",value:function(t){var n=t[this.name];if(null==n)throw new Error("Missing reference "+this.name);return n}}]),n}(),D=function(t){function n(t){N(this,n);var e=C(this,(n.__proto__||Object.getPrototypeOf(n)).call(this,"literal"));return e.value=t,e}return I(n,G),A(n,[{key:"typecheck",value:function(t){return"number"==typeof this.value?S:"string"==typeof this.value?T:"boolean"==typeof this.value?R:x}}]),n}(),F=function(t){function n(t){return N(this,n),C(this,(n.__proto__||Object.getPrototypeOf(n)).call(this,t,"count"))}return I(n,Y),n}(),K=function(t){function n(t){return N(this,n),C(this,(n.__proto__||Object.getPrototypeOf(n)).call(this,t,"cvl"))}return I(n,Y),n}(),V=function(t){function n(t){return N(this,n),C(this,(n.__proto__||Object.getPrototypeOf(n)).call(this,t,"max"))}return I(n,Y),n}(),W=function(t){function n(t){return N(this,n),C(this,(n.__proto__||Object.getPrototypeOf(n)).call(this,t,"min"))}return I(n,Y),n}(),H=function(t){function n(t){return N(this,n),C(this,(n.__proto__||Object.getPrototypeOf(n)).call(this,t,"sum"))}return I(n,Y),n}(),J=function(t){function n(t,e){return N(this,n),C(this,(n.__proto__||Object.getPrototypeOf(n)).call(this,t,e,"eq"))}return I(n,z),A(n,[{key:"typecheck",value:function(t){return e(this.children,t)}}]),n}(),Q=function(t){function n(t,e){return N(this,n),C(this,(n.__proto__||Object.getPrototypeOf(n)).call(this,t,e,"ne"))}return I(n,z),A(n,[{key:"typecheck",value:function(t){return e(this.children,t)}}]),n}(),X=function(t){function n(t,e){return N(this,n),C(this,(n.__proto__||Object.getPrototypeOf(n)).call(this,t,e,"gt"))}return I(n,z),A(n,[{key:"typecheck",value:function(t){return e(this.children,t)}}]),n}(),Z=function(t){function n(t,e){return N(this,n),C(this,(n.__proto__||Object.getPrototypeOf(n)).call(this,t,e,"gte"))}return I(n,z),A(n,[{key:"typecheck",value:function(t){return e(this.children,t)}}]),n}(),$=function(t){function n(t,e){return N(this,n),C(this,(n.__proto__||Object.getPrototypeOf(n)).call(this,t,e,"lt"))}return I(n,z),A(n,[{key:"typecheck",value:function(t){return e(this.children,t)}}]),n}(),tt=function(t){function n(t,e){return N(this,n),C(this,(n.__proto__||Object.getPrototypeOf(n)).call(this,t,e,"lte"))}return I(n,z),A(n,[{key:"typecheck",value:function(t){return e(this.children,t)}}]),n}(),nt=function(t){function e(t,n){return N(this,e),C(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t,n,"and"))}return I(e,z),A(e,[{key:"typecheck",value:function(t){var e=this.children[0].typecheck(t),r=this.children[1].typecheck(t);return n(R,n(e,r))}}]),e}(),et=function(t){function e(t){return N(this,e),C(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t,"not"))}return I(e,q),A(e,[{key:"typecheck",value:function(t){var e=this.children[0].typecheck(t);return n(R,e)}}]),e}(),rt=function(t){function n(t){return N(this,n),C(this,(n.__proto__||Object.getPrototypeOf(n)).call(this,t,"isnull"))}return I(n,q),A(n,[{key:"typecheck",value:function(t){return this.children[0].typecheck(t),R}}]),n}(),it=function(t){function e(t,n){return N(this,e),C(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t,n,"add"))}return I(e,z),A(e,[{key:"typecheck",value:function(t){var e=this.children[0].typecheck(t),r=this.children[1].typecheck(t);return n(S,n(e,r))}}]),e}(),ot=function(t){function e(t,n){return N(this,e),C(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t,n,"sub"))}return I(e,z),A(e,[{key:"typecheck",value:function(t){var e=this.children[0].typecheck(t),r=this.children[1].typecheck(t);return n(S,n(e,r))}}]),e}(),ut=function(t){function e(t,n){return N(this,e),C(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t,n,"mul"))}return I(e,z),A(e,[{key:"typecheck",value:function(t){var e=this.children[0].typecheck(t),r=this.children[1].typecheck(t);return n(S,n(e,r))}}]),e}(),ct=function(t){function e(t,n){return N(this,e),C(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t,n,"div"))}return I(e,z),A(e,[{key:"typecheck",value:function(t){var e=this.children[0].typecheck(t),r=this.children[1].typecheck(t);return n(S,n(e,r))}}]),e}(),ft={UNKNOWN_TYPE:x,NUMBER_TYPE:S,STRING_TYPE:T,BOOLEAN_TYPE:R},at=Object.freeze({types:ft,Expression:U,Aggregate:Y,Reference:B,Literal:D,Count:F,CountValid:K,Max:V,Min:W,Sum:H,Eq:J,Ne:Q,Gt:X,Gte:Z,Lt:$,Lte:tt,And:nt,Not:et,IsNull:rt,Add:it,Sub:ot,Mul:ut,Div:ct}),ht=function(){function t(n,e){N(this,t),this.type=n,this.data=e}return A(t,[{key:"select",value:function(n){return new t(this.type,this.data.filter(function(t,e){return n[e]||!1}))}}],[{key:"fromType",value:function(t,n){switch(t){case T:return new pt(n);case S:return new lt(n);case R:return new yt(n);default:return new st(n)}}}]),t}(),st=function(t){function n(t){return N(this,n),C(this,(n.__proto__||Object.getPrototypeOf(n)).call(this,x,t))}return I(n,ht),n}(),lt=function(t){function n(t){return N(this,n),C(this,(n.__proto__||Object.getPrototypeOf(n)).call(this,S,t))}return I(n,ht),n}(),pt=function(t){function n(t){return N(this,n),C(this,(n.__proto__||Object.getPrototypeOf(n)).call(this,T,t))}return I(n,ht),n}(),yt=function(t){function n(t){return N(this,n),C(this,(n.__proto__||Object.getPrototypeOf(n)).call(this,R,t))}return I(n,ht),n}(),_t=function(t,n){if(t instanceof it)return f(t,n);if(t instanceof ot)return a(t,n);if(t instanceof ut)return h(t,n);if(t instanceof ct)return s(t,n);if(t instanceof rt)return k(t,n);if(t instanceof et)return j(t,n);if(t instanceof J)return v(t,n);if(t instanceof Q)return d(t,n);if(t instanceof X)return w(t,n);if(t instanceof Z)return b(t,n);if(t instanceof $)return O(t,n);if(t instanceof tt)return g(t,n);if(t instanceof nt)return m(t,n);if(t instanceof B)return l(t,n);if(t instanceof D)return p(t,n);throw new Error("Missing handler for op: "+t.op)},vt=0,dt=function(){function t(){N(this,t),this.map={},this.nextId=1+vt}return A(t,[{key:"insert",value:function(t){if(null==t)return vt;var n=t.toString(),e=this.map[n];return null!=e?e:(this.map[n]=this.nextId,this.nextId++)}}]),t}(),wt=function(){function t(n,e){N(this,t),this.op=n,this.input=e,this.current=null}return A(t,[{key:"init",value:function(){return new t(this.op,this.input)}},{key:"insert",value:function(t){var n=this.input.data[t];this.current=P(this.op,this.current,n)}}]),t}(),bt=function(){function t(n,e){N(this,t),this.accs={},this.init=n.map(function(t){var n=_t(t.input,e);return new wt(t.op,n)})}return A(t,[{key:"insert",value:function(t,n){if(0===n.length)return this.global(t);var e=n.toString(),r=this.accs[e];null==r&&(r=this.init.map(function(t){return t.init()}),this.accs[e]=r);var i=!0,o=!1,u=void 0;try{for(var c,f=r[Symbol.iterator]();!(i=(c=f.next()).done);i=!0)c.value.insert(t)}catch(t){o=!0,u=t}finally{try{!i&&f.return&&f.return()}finally{if(o)throw u}}}},{key:"global",value:function(t){var n=!0,e=!1,r=void 0;try{for(var i,o=this.init[Symbol.iterator]();!(n=(i=o.next()).done);n=!0)i.value.insert(t)}catch(t){e=!0,r=t}finally{try{!n&&o.return&&o.return()}finally{if(e)throw r}}}},{key:"finish",value:function(t){var n=this.init.length,e=this.init.map(function(t){return ht.fromType(t.input.type,[])});if(t)for(var r=0;r<n;++r)e[r].data.push(this.init[r].current);else for(var i in this.accs)for(var o=this.accs[i],u=0;u<n;++u)e[u].data.push(o[u].current);return e}}]),t}(),Ot=function(t,n,e){for(var r=t[0][1].data.length,i=n.length,o=n.map(function(n){return _t(n,t)}),u=o.map(function(){return new dt}),c=new Uint32Array(i),f=new bt(e,t),a=0;a<r;++a){for(var h=0;h<i;++h){var s=u[h],l=o[h].data[a];c[h]=s.insert(l)}f.insert(a,c)}return f.finish(0===i)},gt=function(t,n){var e=E(n),r=t.typecheck(e),i=_t(t,n);if(i.type!==r)throw new Error("Runtime Type Error: "+i.type+" !== "+r);return i},mt=function(){function t(n){N(this,t),this._child=n}return A(t,[{key:"child",value:function(){if(null==this._child)throw new Error("operator has no child");return this._child}},{key:"execute",value:function(){throw new Error("execute() not implemented")}}]),t}(),kt=function(t){function n(t){N(this,n);var e=C(this,(n.__proto__||Object.getPrototypeOf(n)).call(this,null));return e.table=t,e}return I(n,mt),A(n,[{key:"execute",value:function(){return this.table}}]),n}(),jt=function(t){function n(t,e){N(this,n);var r=C(this,(n.__proto__||Object.getPrototypeOf(n)).call(this,t));return r.expressions=e,r}return I(n,mt),A(n,[{key:"execute",value:function(){var t=this.child().execute();return this.expressions.map(function(n){var e=L(n,2),r=e[0],i=e[1];return[r,gt(i,t)]})}}]),n}(),Pt=function(t){function n(t,e){N(this,n);var r=C(this,(n.__proto__||Object.getPrototypeOf(n)).call(this,t));return r.predicate=e.reduce(function(t,n){return new nt(t,n)}),r}return I(n,mt),A(n,[{key:"execute",value:function(){var t=this.child().execute(),n=gt(this.predicate,t).data;return t.map(function(t){var e=L(t,2);return[e[0],e[1].select(n)]})}}]),n}(),Et=function(t){function n(t,e,r){N(this,n);var i=C(this,(n.__proto__||Object.getPrototypeOf(n)).call(this,t));return i.keys=e,i.aggs=r,i}return I(n,mt),A(n,[{key:"execute",value:function(){var t=this,n=this.child().execute();return Ot(n,this.keys,this.aggs.map(function(t){return t[1]})).map(function(n,e){return[t.aggs[e][0],n]})}}]),n}(),xt=Object.freeze({Scan:kt,Project:jt,Filter:Pt,Aggregate:Et}),St={loadColumns:function(t){var n=[],e=!0,r=!1,i=void 0;try{for(var o,u=t[Symbol.iterator]();!(e=(o=u.next()).done);e=!0){var c=o.value;n.push([c.name,ht.fromType(c.type,c.data)])}}catch(t){r=!0,i=t}finally{try{!e&&u.return&&u.return()}finally{if(r)throw i}}return n}};t.operator=xt,t.expression=at,t.loaders=St,Object.defineProperty(t,"__esModule",{value:!0})});