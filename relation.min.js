!function(t,n){"object"==typeof exports&&"undefined"!=typeof module?n(exports):"function"==typeof define&&define.amd?define(["exports"],n):n(t.relation={})}(this,function(t){"use strict";function n(t,n){if(t!==n)throw new Error("Mismatched types: "+t+" !== "+n);return t}function e(t){throw new Error("typecheck() is not implemented")}function r(t){var n=t[this.name];if(null==n)throw new Error("Missing reference "+this.name);return n}function i(t){return"number"==typeof this.value?Ot:"string"==typeof this.value?gt:"boolean"==typeof this.value?mt:bt}function o(t,e){return n(t[0].typecheck(e),t[1].typecheck(e)),mt}function u(t){return o(this.children,t)}function c(t){return o(this.children,t)}function f(t){return o(this.children,t)}function a(t){return o(this.children,t)}function h(t){return o(this.children,t)}function s(t){return o(this.children,t)}function l(t){var e=this.children[0].typecheck(t),r=this.children[1].typecheck(t);return n(mt,n(e,r))}function p(t){var e=this.children[0].typecheck(t);return n(mt,e)}function y(t){return this.children[0].typecheck(t),mt}function _(t){var e=this.children[0].typecheck(t),r=this.children[1].typecheck(t);return n(Ot,n(e,r))}function v(t){var e=this.children[0].typecheck(t),r=this.children[1].typecheck(t);return n(Ot,n(e,r))}function d(t){var e=this.children[0].typecheck(t),r=this.children[1].typecheck(t);return n(Ot,n(e,r))}function w(t){var e=this.children[0].typecheck(t),r=this.children[1].typecheck(t);return n(Ot,n(e,r))}function b(t,n,e){var r=t.length;if(r!==n.length)throw new Error("length doesn't match");for(var i=t.slice(0),o=0;o<r;o++){var u=i[o];if(null!=u){var c=n[o];i[o]=null==c?null:e(u,c)}}return i}function O(t,n){return t.map(n)}function g(t,n){return t.map(function(t){return null==t?null:n(t)})}function m(t,n){var e=new Array(t);if(e.fill)e.fill(n);else for(var r=0;r<t;++r)e[r]=n;return e}function k(t,n){var e=m(t,n);switch(void 0===n?"undefined":kt(n)){case"string":return new en(gt,e);case"number":return new en(Ot,e);case"boolean":return new en(mt,e);default:return new en(bt,e)}}function j(t,n,e){var r=fn(t.children[0],n);if(r.type!==Ot)throw new Error("Runtime Error: wrong type");var i=fn(t.children[1],n);if(i.type!==Ot)throw new Error("Runtime Error: wrong type");var o=b(r.data,i.data,e);return new on(o)}function P(t,n){return t+n}function E(t,n){return j(t,n,P)}function x(t,n){return t-n}function S(t,n){return j(t,n,x)}function T(t,n){return t*n}function R(t,n){return j(t,n,T)}function A(t,n){return t/n}function M(t,n){return j(t,n,A)}function N(t,n){var e=n.find(function(n){var e=St(n,2),r=e[0];e[1];return t.name===r});if(null==e)throw new Error("Missing reference "+t.name);return e[1]}function I(t,n){return k(n[0][1].data.length,t.value)}function U(t,n,e){var r=fn(t.children[0],n),i=fn(t.children[1],n);if(r.type!==i.type)throw new Error("Runtime Error: wrong type");var o=b(r.data,i.data,e);return new cn(o)}function C(t,n,e){var r=fn(t.children[0],n),i=fn(t.children[1],n);if(r.type!==mt)throw new Error("Runtime Error: wrong type");if(i.type!==mt)throw new Error("Runtime Error: wrong type");var o=b(r.data,i.data,e);return new cn(o)}function L(t,n){return t===n}function Y(t,n){return U(t,n,L)}function G(t,n){return t!==n}function q(t,n){return U(t,n,G)}function z(t,n){return t>n}function B(t,n){return U(t,n,z)}function D(t,n){return t>=n}function F(t,n){return U(t,n,D)}function K(t,n){return t<n}function V(t,n){return U(t,n,K)}function W(t,n){return t<=n}function H(t,n){return U(t,n,W)}function J(t,n){return t&&n}function Q(t,n){return C(t,n,J)}function X(t){return null==t}function Z(t,n){var e=O(fn(t.children[0],n).data,X);return new cn(e)}function $(t){return!t}function tt(t,n){var e=fn(t.children[0],n);if(e.type!==mt)throw new Error("Runtime Error: wrong type");var r=g(e.data,$);return new cn(r)}function nt(t){if(null==t)return an;var n=t.toString(),e=this.map[n];return null!=e?e:(this.map[n]=this.nextId,this.nextId++)}function et(t){var n=this.input.data[t];this.current=ht(this.op,this.current,n)}function rt(){switch(this.op){case"min":case"max":return this.input.type;case"count":case"cvl":case"sum":return Ot;default:throw new Error("Unexpected op: "+this.op)}}function it(t){return t.init()}function ot(t,n){if(0===n.length)return this.global(t);var e=n.toString(),r=this.accs[e];null==r&&(r=this.init.map(it),this.accs[e]=r);var i=!0,o=!1,u=void 0;try{for(var c,f=r[Symbol.iterator]();!(i=(c=f.next()).done);i=!0)c.value.insert(t)}catch(t){o=!0,u=t}finally{try{!i&&f.return&&f.return()}finally{if(o)throw u}}}function ut(t){var n=!0,e=!1,r=void 0;try{for(var i,o=this.init[Symbol.iterator]();!(n=(i=o.next()).done);n=!0)i.value.insert(t)}catch(t){e=!0,r=t}finally{try{!n&&o.return&&o.return()}finally{if(e)throw r}}}function ct(t){return en.fromType(t.type(),[])}function ft(t){var n=this.init.length,e=this.init.map(ct);if(t)for(var r=0;r<n;++r)e[r].data.push(this.init[r].current);else for(var i in this.accs)for(var o=this.accs[i],u=0;u<n;++u)e[u].data.push(o[u].current);return e}function at(){return new hn}function ht(t,n,e){if("count"===t)return(n||0)+1;if("cvl"===t)return null==e?n||0:(n||0)+1;if(null==e)return n;if(null==n)return e;switch(t){case"min":return e<n?e:n;case"max":return e>n?e:n;case"sum":return(n||0)+(e||0);default:throw new Error("Unexpected op: "+t)}}function st(t){var n={},e=!0,r=!1,i=void 0;try{for(var o,u=t[Symbol.iterator]();!(e=(o=u.next()).done);e=!0){var c=o.value,f=St(c,2),a=f[0],h=f[1];if(null!=n[a])throw new Error("Duplicate field name: "+a);n[a]=h.type}}catch(t){r=!0,i=t}finally{try{!e&&u.return&&u.return()}finally{if(r)throw i}}return n}function lt(){throw new Error("execute() not implemented")}function pt(){return this.table}function yt(){var t=this.child().execute();return this.expressions.map(function(n){return[n[0],yn(n[1],t)]})}function _t(t,n){return new Wt(t,n)}function vt(){var t=this.child().execute(),n=yn(this.predicate,t).data;return t.map(function(t){var e=St(t,2);return[e[0],e[1].select(n)]})}function dt(t){return t[1]}function wt(){var t=this,n=this.child().execute();return pn(n,this.keys,this.aggs.map(dt)).map(function(n,e){return[t.aggs[e][0],n]})}var bt="unknown",Ot="number",gt="string",mt="boolean",kt="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},jt=function(t,n){if(!(t instanceof n))throw new TypeError("Cannot call a class as a function")},Pt=function(){function t(t,n){for(var e=0;e<n.length;e++){var r=n[e];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(n,e,r){return e&&t(n.prototype,e),r&&t(n,r),n}}(),Et=function(t,n){if("function"!=typeof n&&null!==n)throw new TypeError("Super expression must either be null or a function, not "+typeof n);t.prototype=Object.create(n&&n.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),n&&(Object.setPrototypeOf?Object.setPrototypeOf(t,n):t.__proto__=n)},xt=function(t,n){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!n||"object"!=typeof n&&"function"!=typeof n?t:n},St=function(){function t(t,n){var e=[],r=!0,i=!1,o=void 0;try{for(var u,c=t[Symbol.iterator]();!(r=(u=c.next()).done)&&(e.push(u.value),!n||e.length!==n);r=!0);}catch(t){i=!0,o=t}finally{try{!r&&c.return&&c.return()}finally{if(i)throw o}}return e}return function(n,e){if(Array.isArray(n))return n;if(Symbol.iterator in Object(n))return t(n,e);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),Tt=function(){function t(n,e){jt(this,t),this.children=n,this.op=e}return Pt(t,[{key:"typecheck",value:e}]),t}(),Rt=function(t){function n(t,e){jt(this,n);var r=xt(this,(n.__proto__||Object.getPrototypeOf(n)).call(this,[t],e));return r.input=t,r}return Et(n,Tt),n}(),At=function(t){function n(t){return jt(this,n),xt(this,(n.__proto__||Object.getPrototypeOf(n)).call(this,[],t))}return Et(n,Tt),n}(),Mt=function(t){function n(t,e){return jt(this,n),xt(this,(n.__proto__||Object.getPrototypeOf(n)).call(this,[t],e))}return Et(n,Tt),n}(),Nt=function(t){function n(t,e,r){return jt(this,n),xt(this,(n.__proto__||Object.getPrototypeOf(n)).call(this,[t,e],r))}return Et(n,Tt),n}(),It=function(t){function n(t){jt(this,n);var e=xt(this,(n.__proto__||Object.getPrototypeOf(n)).call(this,"reference"));return e.name=t,e}return Et(n,At),Pt(n,[{key:"typecheck",value:r}]),n}(),Ut=function(t){function n(t){jt(this,n);var e=xt(this,(n.__proto__||Object.getPrototypeOf(n)).call(this,"literal"));return e.value=t,e}return Et(n,At),Pt(n,[{key:"typecheck",value:i}]),n}(),Ct=function(t){function n(t){return jt(this,n),xt(this,(n.__proto__||Object.getPrototypeOf(n)).call(this,t,"count"))}return Et(n,Rt),n}(),Lt=function(t){function n(t){return jt(this,n),xt(this,(n.__proto__||Object.getPrototypeOf(n)).call(this,t,"cvl"))}return Et(n,Rt),n}(),Yt=function(t){function n(t){return jt(this,n),xt(this,(n.__proto__||Object.getPrototypeOf(n)).call(this,t,"max"))}return Et(n,Rt),n}(),Gt=function(t){function n(t){return jt(this,n),xt(this,(n.__proto__||Object.getPrototypeOf(n)).call(this,t,"min"))}return Et(n,Rt),n}(),qt=function(t){function n(t){return jt(this,n),xt(this,(n.__proto__||Object.getPrototypeOf(n)).call(this,t,"sum"))}return Et(n,Rt),n}(),zt=function(t){function n(t,e){return jt(this,n),xt(this,(n.__proto__||Object.getPrototypeOf(n)).call(this,t,e,"eq"))}return Et(n,Nt),Pt(n,[{key:"typecheck",value:u}]),n}(),Bt=function(t){function n(t,e){return jt(this,n),xt(this,(n.__proto__||Object.getPrototypeOf(n)).call(this,t,e,"ne"))}return Et(n,Nt),Pt(n,[{key:"typecheck",value:c}]),n}(),Dt=function(t){function n(t,e){return jt(this,n),xt(this,(n.__proto__||Object.getPrototypeOf(n)).call(this,t,e,"gt"))}return Et(n,Nt),Pt(n,[{key:"typecheck",value:f}]),n}(),Ft=function(t){function n(t,e){return jt(this,n),xt(this,(n.__proto__||Object.getPrototypeOf(n)).call(this,t,e,"gte"))}return Et(n,Nt),Pt(n,[{key:"typecheck",value:a}]),n}(),Kt=function(t){function n(t,e){return jt(this,n),xt(this,(n.__proto__||Object.getPrototypeOf(n)).call(this,t,e,"lt"))}return Et(n,Nt),Pt(n,[{key:"typecheck",value:h}]),n}(),Vt=function(t){function n(t,e){return jt(this,n),xt(this,(n.__proto__||Object.getPrototypeOf(n)).call(this,t,e,"lte"))}return Et(n,Nt),Pt(n,[{key:"typecheck",value:s}]),n}(),Wt=function(t){function n(t,e){return jt(this,n),xt(this,(n.__proto__||Object.getPrototypeOf(n)).call(this,t,e,"and"))}return Et(n,Nt),Pt(n,[{key:"typecheck",value:l}]),n}(),Ht=function(t){function n(t){return jt(this,n),xt(this,(n.__proto__||Object.getPrototypeOf(n)).call(this,t,"not"))}return Et(n,Mt),Pt(n,[{key:"typecheck",value:p}]),n}(),Jt=function(t){function n(t){return jt(this,n),xt(this,(n.__proto__||Object.getPrototypeOf(n)).call(this,t,"isnull"))}return Et(n,Mt),Pt(n,[{key:"typecheck",value:y}]),n}(),Qt=function(t){function n(t,e){return jt(this,n),xt(this,(n.__proto__||Object.getPrototypeOf(n)).call(this,t,e,"add"))}return Et(n,Nt),Pt(n,[{key:"typecheck",value:_}]),n}(),Xt=function(t){function n(t,e){return jt(this,n),xt(this,(n.__proto__||Object.getPrototypeOf(n)).call(this,t,e,"sub"))}return Et(n,Nt),Pt(n,[{key:"typecheck",value:v}]),n}(),Zt=function(t){function n(t,e){return jt(this,n),xt(this,(n.__proto__||Object.getPrototypeOf(n)).call(this,t,e,"mul"))}return Et(n,Nt),Pt(n,[{key:"typecheck",value:d}]),n}(),$t=function(t){function n(t,e){return jt(this,n),xt(this,(n.__proto__||Object.getPrototypeOf(n)).call(this,t,e,"div"))}return Et(n,Nt),Pt(n,[{key:"typecheck",value:w}]),n}(),tn={UNKNOWN_TYPE:bt,NUMBER_TYPE:Ot,STRING_TYPE:gt,BOOLEAN_TYPE:mt},nn=Object.freeze({types:tn,Expression:Tt,Aggregate:Rt,Reference:It,Literal:Ut,Count:Ct,CountValid:Lt,Max:Yt,Min:Gt,Sum:qt,Eq:zt,Ne:Bt,Gt:Dt,Gte:Ft,Lt:Kt,Lte:Vt,And:Wt,Not:Ht,IsNull:Jt,Add:Qt,Sub:Xt,Mul:Zt,Div:$t}),en=function(){function t(n,e){jt(this,t),this.type=n,this.data=e}return Pt(t,[{key:"select",value:function(n){return new t(this.type,this.data.filter(function(t,e){return!!n[e]||!1}))}}],[{key:"fromType",value:function(t,n){switch(t){case gt:return new un(n);case Ot:return new on(n);case mt:return new cn(n);default:return new rn(n)}}}]),t}(),rn=function(t){function n(t){return jt(this,n),xt(this,(n.__proto__||Object.getPrototypeOf(n)).call(this,bt,t))}return Et(n,en),n}(),on=function(t){function n(t){return jt(this,n),xt(this,(n.__proto__||Object.getPrototypeOf(n)).call(this,Ot,t))}return Et(n,en),n}(),un=function(t){function n(t){return jt(this,n),xt(this,(n.__proto__||Object.getPrototypeOf(n)).call(this,gt,t))}return Et(n,en),n}(),cn=function(t){function n(t){return jt(this,n),xt(this,(n.__proto__||Object.getPrototypeOf(n)).call(this,mt,t))}return Et(n,en),n}(),fn=function(t,n){if(t instanceof Qt)return E(t,n);if(t instanceof Xt)return S(t,n);if(t instanceof Zt)return R(t,n);if(t instanceof $t)return M(t,n);if(t instanceof Jt)return Z(t,n);if(t instanceof Ht)return tt(t,n);if(t instanceof zt)return Y(t,n);if(t instanceof Bt)return q(t,n);if(t instanceof Dt)return B(t,n);if(t instanceof Ft)return F(t,n);if(t instanceof Kt)return V(t,n);if(t instanceof Vt)return H(t,n);if(t instanceof Wt)return Q(t,n);if(t instanceof It)return N(t,n);if(t instanceof Ut)return I(t,n);throw new Error("Missing handler for op: "+t.op)},an=0,hn=function(){function t(){jt(this,t),this.map={},this.nextId=1+an}return Pt(t,[{key:"insert",value:nt}]),t}(),sn=function(){function t(n,e){jt(this,t),this.op=n,this.input=e,this.current=null}return Pt(t,[{key:"init",value:function(){return new t(this.op,this.input)}},{key:"insert",value:et},{key:"type",value:rt}]),t}(),ln=function(){function t(n,e){jt(this,t),this.accs={},this.init=n.map(function(t){var n=fn(t.input,e);return new sn(t.op,n)})}return Pt(t,[{key:"insert",value:ot},{key:"global",value:ut},{key:"finish",value:ft}]),t}(),pn=function(t,n,e){for(var r=t[0][1].data.length,i=n.length,o=n.map(function(n){return fn(n,t)}),u=o.map(at),c=new Uint32Array(i),f=new ln(e,t),a=0;a<r;++a){for(var h=0;h<i;++h){var s=u[h],l=o[h].data[a];c[h]=s.insert(l)}f.insert(a,c)}return f.finish(0===i)},yn=function(t,n){var e=st(n),r=t.typecheck(e),i=fn(t,n);if(i.type!==r)throw new Error("Runtime Type Error: "+i.type+" !== "+r);return i},_n=function(){function t(n){jt(this,t),this._child=n}return Pt(t,[{key:"child",value:function(){if(null==this._child)throw new Error("operator has no child");return this._child}},{key:"execute",value:lt}]),t}(),vn=function(t){function n(t){jt(this,n);var e=xt(this,(n.__proto__||Object.getPrototypeOf(n)).call(this,null));return e.table=t,e}return Et(n,_n),Pt(n,[{key:"execute",value:pt}]),n}(),dn=function(t){function n(t,e){jt(this,n);var r=xt(this,(n.__proto__||Object.getPrototypeOf(n)).call(this,t));return r.expressions=e,r}return Et(n,_n),Pt(n,[{key:"execute",value:yt}]),n}(),wn=function(t){function n(t,e){jt(this,n);var r=xt(this,(n.__proto__||Object.getPrototypeOf(n)).call(this,t));return r.predicate=e.reduce(_t),r}return Et(n,_n),Pt(n,[{key:"execute",value:vt}]),n}(),bn=function(t){function n(t,e,r){jt(this,n);var i=xt(this,(n.__proto__||Object.getPrototypeOf(n)).call(this,t));return i.keys=e,i.aggs=r,i}return Et(n,_n),Pt(n,[{key:"execute",value:wt}]),n}(),On=Object.freeze({Scan:vn,Project:dn,Filter:wn,Aggregate:bn}),gn={loadColumns:function(t){var n=[],e=!0,r=!1,i=void 0;try{for(var o,u=t[Symbol.iterator]();!(e=(o=u.next()).done);e=!0){var c=o.value;n.push([c.name,en.fromType(c.type,c.data)])}}catch(t){r=!0,i=t}finally{try{!e&&u.return&&u.return()}finally{if(r)throw i}}return n}};t.operator=On,t.expression=nn,t.loaders=gn,Object.defineProperty(t,"__esModule",{value:!0})});