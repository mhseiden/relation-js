!function(t,n){"object"==typeof exports&&"undefined"!=typeof module?n(exports):"function"==typeof define&&define.amd?define(["exports"],n):n(t.reljs={})}(this,function(t){"use strict";function n(t,n){if(t!==n)throw new Error("Mismatched types: "+t+" !== "+n);return t}function e(t,n){for(var e=[];t>0;--t)e.push(n);switch(void 0===n?"undefined":E(n)){case"string":return new nt(j,e);case"number":return new nt(k,e);case"boolean":return new nt(P,e);default:return new nt(m,e)}}function r(t,n,e){var r=t.length;if(r!==n.length)throw new Error("length doesn't match");for(var i=[],o=0;o<r;o++){var u=t[o],c=n[o];null==u||null==c?i.push(null):i.push(e(u,c))}return i}function i(t,n){return t.map(n)}function o(t,n){return t.map(function(t){return null==t?null:n(t)})}function u(t,n,e){var i=ut(t.children[0],n);if(i.type!==k)throw new Error("Runtime Error: wrong type");var o=ut(t.children[1],n);if(o.type!==k)throw new Error("Runtime Error: wrong type");var u=r(i.data,o.data,e);return new rt(u)}function c(t,n){return u(t,n,function(t,n){return t+n})}function f(t,n){return u(t,n,function(t,n){return t-n})}function a(t,n){return u(t,n,function(t,n){return t*n})}function h(t,n){return u(t,n,function(t,n){return t/n})}function s(t,n){var e=n.find(function(n){var e=M(n,2),r=e[0];e[1];return t.name===r});if(null==e)throw new Error("Missing reference "+t.name);return e[1]}function l(t,n){return e(n[0][1].data.length,t.value)}function p(t,n,e){var i=ut(t.children[0],n),o=ut(t.children[1],n);if(i.type!==o.type)throw new Error("Runtime Error: wrong type");var u=r(i.data,o.data,e);return new ot(u)}function y(t,n,e){var i=ut(t.children[0],n),o=ut(t.children[1],n);if(i.type!==P)throw new Error("Runtime Error: wrong type");if(o.type!==P)throw new Error("Runtime Error: wrong type");var u=r(i.data,o.data,e);return new ot(u)}function _(t,n){return p(t,n,function(t,n){return t===n})}function v(t,n){return p(t,n,function(t,n){return t!==n})}function d(t,n){return y(t,n,function(t,n){return t&&n})}function w(t,n){var e=i(ut(t.children[0],n).data,function(t){return null==t});return new ot(e)}function b(t,n){var e=ut(t.children[0],n);if(e.type!==P)throw new Error("Runtime Error: wrong type");var r=o(e.data,function(t){return!t});return new ot(r)}function O(t,n,e){if("count"===t)return(n||0)+1;if("cvl"===t)return null==e?n||0:(n||0)+1;if(null==e)return n;if(null==n)return e;switch(t){case"min":return e<n?e:n;case"max":return e>n?e:n;case"sum":return(n||0)+(e||0);default:throw new Error("Unexpected op: "+t)}}function g(t){var n={},e=!0,r=!1,i=void 0;try{for(var o,u=t[Symbol.iterator]();!(e=(o=u.next()).done);e=!0){var c=o.value,f=M(c,2),a=f[0],h=f[1];if(null!=n[a])throw new Error("Duplicate field name: "+a);n[a]=h.type}}catch(t){r=!0,i=t}finally{try{!e&&u.return&&u.return()}finally{if(r)throw i}}return n}var m="unknown",k="number",j="string",P="boolean",E="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},x=function(t,n){if(!(t instanceof n))throw new TypeError("Cannot call a class as a function")},S=function(){function t(t,n){for(var e=0;e<n.length;e++){var r=n[e];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(n,e,r){return e&&t(n.prototype,e),r&&t(n,r),n}}(),R=function(t,n){if("function"!=typeof n&&null!==n)throw new TypeError("Super expression must either be null or a function, not "+typeof n);t.prototype=Object.create(n&&n.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),n&&(Object.setPrototypeOf?Object.setPrototypeOf(t,n):t.__proto__=n)},T=function(t,n){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!n||"object"!=typeof n&&"function"!=typeof n?t:n},M=function(){function t(t,n){var e=[],r=!0,i=!1,o=void 0;try{for(var u,c=t[Symbol.iterator]();!(r=(u=c.next()).done)&&(e.push(u.value),!n||e.length!==n);r=!0);}catch(t){i=!0,o=t}finally{try{!r&&c.return&&c.return()}finally{if(i)throw o}}return e}return function(n,e){if(Array.isArray(n))return n;if(Symbol.iterator in Object(n))return t(n,e);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),N=function(){function t(n,e){x(this,t),this.children=n,this.op=e}return S(t,[{key:"typecheck",value:function(t){throw new Error("typecheck() is not implemented")}}]),t}(),A=function(t){function n(t,e){x(this,n);var r=T(this,(n.__proto__||Object.getPrototypeOf(n)).call(this,[t],e));return r.input=t,r}return R(n,N),n}(),I=function(t){function n(t){return x(this,n),T(this,(n.__proto__||Object.getPrototypeOf(n)).call(this,[],t))}return R(n,N),n}(),U=function(t){function n(t,e){return x(this,n),T(this,(n.__proto__||Object.getPrototypeOf(n)).call(this,[t],e))}return R(n,N),n}(),Y=function(t){function n(t,e,r){return x(this,n),T(this,(n.__proto__||Object.getPrototypeOf(n)).call(this,[t,e],r))}return R(n,N),n}(),C=function(t){function n(t){x(this,n);var e=T(this,(n.__proto__||Object.getPrototypeOf(n)).call(this,"reference"));return e.name=t,e}return R(n,I),S(n,[{key:"typecheck",value:function(t){var n=t[this.name];if(null==n)throw new Error("Missing reference "+this.name);return n}}]),n}(),q=function(t){function n(t){x(this,n);var e=T(this,(n.__proto__||Object.getPrototypeOf(n)).call(this,"literal"));return e.value=t,e}return R(n,I),S(n,[{key:"typecheck",value:function(t){return"number"==typeof this.value?k:"string"==typeof this.value?j:"boolean"==typeof this.value?P:m}}]),n}(),z=function(t){function n(t){return x(this,n),T(this,(n.__proto__||Object.getPrototypeOf(n)).call(this,t,"count"))}return R(n,A),n}(),B=function(t){function n(t){return x(this,n),T(this,(n.__proto__||Object.getPrototypeOf(n)).call(this,t,"cvl"))}return R(n,A),n}(),D=function(t){function n(t){return x(this,n),T(this,(n.__proto__||Object.getPrototypeOf(n)).call(this,t,"max"))}return R(n,A),n}(),L=function(t){function n(t){return x(this,n),T(this,(n.__proto__||Object.getPrototypeOf(n)).call(this,t,"min"))}return R(n,A),n}(),F=function(t){function n(t){return x(this,n),T(this,(n.__proto__||Object.getPrototypeOf(n)).call(this,t,"sum"))}return R(n,A),n}(),G=function(t){function e(t,n){return x(this,e),T(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t,n,"eq"))}return R(e,Y),S(e,[{key:"typecheck",value:function(t){return n(this.children[0].typecheck(t),this.children[1].typecheck(t)),P}}]),e}(),K=function(t){function e(t,n){return x(this,e),T(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t,n,"ne"))}return R(e,Y),S(e,[{key:"typecheck",value:function(t){return n(this.children[0].typecheck(t),this.children[1].typecheck(t)),P}}]),e}(),V=function(t){function e(t,n){return x(this,e),T(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t,n,"and"))}return R(e,Y),S(e,[{key:"typecheck",value:function(t){var e=this.children[0].typecheck(t),r=this.children[1].typecheck(t);return n(P,n(e,r))}}]),e}(),W=function(t){function e(t){return x(this,e),T(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t,"not"))}return R(e,U),S(e,[{key:"typecheck",value:function(t){var e=this.children[0].typecheck(t);return n(P,e)}}]),e}(),H=function(t){function n(t){return x(this,n),T(this,(n.__proto__||Object.getPrototypeOf(n)).call(this,t,"isnull"))}return R(n,U),S(n,[{key:"typecheck",value:function(t){return this.children[0].typecheck(t),P}}]),n}(),J=function(t){function e(t,n){return x(this,e),T(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t,n,"add"))}return R(e,Y),S(e,[{key:"typecheck",value:function(t){var e=this.children[0].typecheck(t),r=this.children[1].typecheck(t);return n(k,n(e,r))}}]),e}(),Q=function(t){function e(t,n){return x(this,e),T(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t,n,"sub"))}return R(e,Y),S(e,[{key:"typecheck",value:function(t){var e=this.children[0].typecheck(t),r=this.children[1].typecheck(t);return n(k,n(e,r))}}]),e}(),X=function(t){function e(t,n){return x(this,e),T(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t,n,"mul"))}return R(e,Y),S(e,[{key:"typecheck",value:function(t){var e=this.children[0].typecheck(t),r=this.children[1].typecheck(t);return n(k,n(e,r))}}]),e}(),Z=function(t){function e(t,n){return x(this,e),T(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t,n,"div"))}return R(e,Y),S(e,[{key:"typecheck",value:function(t){var e=this.children[0].typecheck(t),r=this.children[1].typecheck(t);return n(k,n(e,r))}}]),e}(),$={UNKNOWN_TYPE:m,NUMBER_TYPE:k,STRING_TYPE:j,BOOLEAN_TYPE:P},tt=Object.freeze({types:$,Expression:N,Aggregate:A,Reference:C,Literal:q,Count:z,CountValid:B,Max:D,Min:L,Sum:F,Eq:G,Ne:K,And:V,Not:W,IsNull:H,Add:J,Sub:Q,Mul:X,Div:Z}),nt=function(){function t(n,e){x(this,t),this.type=n,this.data=e}return S(t,[{key:"select",value:function(n){return new t(this.type,this.data.filter(function(t,e){return n[e]||!1}))}}],[{key:"fromType",value:function(t,n){switch(t){case j:return new it(n);case k:return new rt(n);case P:return new ot(n);default:return new et(n)}}}]),t}(),et=function(t){function n(t){return x(this,n),T(this,(n.__proto__||Object.getPrototypeOf(n)).call(this,m,t))}return R(n,nt),n}(),rt=function(t){function n(t){return x(this,n),T(this,(n.__proto__||Object.getPrototypeOf(n)).call(this,k,t))}return R(n,nt),n}(),it=function(t){function n(t){return x(this,n),T(this,(n.__proto__||Object.getPrototypeOf(n)).call(this,j,t))}return R(n,nt),n}(),ot=function(t){function n(t){return x(this,n),T(this,(n.__proto__||Object.getPrototypeOf(n)).call(this,P,t))}return R(n,nt),n}(),ut=function(t,n){if(t instanceof J)return c(t,n);if(t instanceof Q)return f(t,n);if(t instanceof X)return a(t,n);if(t instanceof Z)return h(t,n);if(t instanceof H)return w(t,n);if(t instanceof W)return b(t,n);if(t instanceof G)return _(t,n);if(t instanceof K)return v(t,n);if(t instanceof V)return d(t,n);if(t instanceof C)return s(t,n);if(t instanceof q)return l(t,n);throw new Error("Missing handler for op: "+t.op)},ct=0,ft=function(){function t(){x(this,t),this.map={},this.nextId=1+ct}return S(t,[{key:"insert",value:function(t){if(null==t)return ct;var n=t.toString(),e=this.map[n];return null!=e?e:(this.map[n]=this.nextId,this.nextId++)}}]),t}(),at=function(){function t(n,e){x(this,t),this.op=n,this.input=e,this.current=null}return S(t,[{key:"init",value:function(){return new t(this.op,this.input)}},{key:"insert",value:function(t){var n=this.input.data[t];this.current=O(this.op,this.current,n)}}]),t}(),ht=function(){function t(n,e){x(this,t),this.accs={},this.init=n.map(function(t){var n=ut(t.input,e);return new at(t.op,n)})}return S(t,[{key:"insert",value:function(t,n){if(0===n.length)return this.global(t);var e=n.toString(),r=this.accs[e];null==r&&(r=this.init.map(function(t){return t.init()}),this.accs[e]=r);var i=!0,o=!1,u=void 0;try{for(var c,f=r[Symbol.iterator]();!(i=(c=f.next()).done);i=!0)c.value.insert(t)}catch(t){o=!0,u=t}finally{try{!i&&f.return&&f.return()}finally{if(o)throw u}}}},{key:"global",value:function(t){var n=!0,e=!1,r=void 0;try{for(var i,o=this.init[Symbol.iterator]();!(n=(i=o.next()).done);n=!0)i.value.insert(t)}catch(t){e=!0,r=t}finally{try{!n&&o.return&&o.return()}finally{if(e)throw r}}}},{key:"finish",value:function(t){var n=this.init.length,e=this.init.map(function(t){return nt.fromType(t.input.type,[])});if(t)for(var r=0;r<n;++r)e[r].data.push(this.init[r].current);else for(var i in this.accs)for(var o=this.accs[i],u=0;u<n;++u)e[u].data.push(o[u].current);return e}}]),t}(),st=function(t,n,e){for(var r=t[0][1].data.length,i=n.length,o=n.map(function(n){return ut(n,t)}),u=o.map(function(){return new ft}),c=new Uint32Array(i),f=new ht(e,t),a=0;a<r;++a){for(var h=0;h<i;++h){var s=u[h],l=o[h].data[a];c[h]=s.insert(l)}f.insert(a,c)}return f.finish(0===i)},lt=function(t,n){var e=g(n),r=t.typecheck(e),i=ut(t,n);if(i.type!==r)throw new Error("Runtime Type Error: "+i.type+" !== "+r);return i},pt=function(){function t(n){x(this,t),this._child=n}return S(t,[{key:"child",value:function(){if(null==this._child)throw new Error("operator has no child");return this._child}},{key:"execute",value:function(){throw new Error("execute() not implemented")}}]),t}(),yt=function(t){function n(t){x(this,n);var e=T(this,(n.__proto__||Object.getPrototypeOf(n)).call(this,null));return e.table=t,e}return R(n,pt),S(n,[{key:"execute",value:function(){return this.table}}]),n}(),_t=function(t){function n(t,e){x(this,n);var r=T(this,(n.__proto__||Object.getPrototypeOf(n)).call(this,t));return r.expressions=e,r}return R(n,pt),S(n,[{key:"execute",value:function(){var t=this.child().execute();return this.expressions.map(function(n){var e=M(n,2),r=e[0],i=e[1];return[r,lt(i,t)]})}}]),n}(),vt=function(t){function n(t,e){x(this,n);var r=T(this,(n.__proto__||Object.getPrototypeOf(n)).call(this,t));return r.predicate=e.reduce(function(t,n){return new V(t,n)}),r}return R(n,pt),S(n,[{key:"execute",value:function(){var t=this.child().execute(),n=lt(this.predicate,t).data;return t.map(function(t){var e=M(t,2);return[e[0],e[1].select(n)]})}}]),n}(),dt=function(t){function n(t,e,r){x(this,n);var i=T(this,(n.__proto__||Object.getPrototypeOf(n)).call(this,t));return i.keys=e,i.aggs=r,i}return R(n,pt),S(n,[{key:"execute",value:function(){var t=this,n=this.child().execute();return st(n,this.keys,this.aggs.map(function(t){return t[1]})).map(function(n,e){return[t.aggs[e][0],n]})}}]),n}(),wt=Object.freeze({Scan:yt,Project:_t,Filter:vt,Aggregate:dt});t.operator=wt,t.expression=tt,Object.defineProperty(t,"__esModule",{value:!0})});